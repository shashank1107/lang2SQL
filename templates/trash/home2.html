{% extends 'tool/base-template.html' %}

{% block main-body %}
    {#    === HEADER CODE START === #}
    <header class="flex justify-center py-4 bg-blue-500 mb-5">
        <a href="#" class="text-3xl font-bold text-gray-100">Lang2SQL</a>
    </header>
    {#    === HEADER CODE END ===#}

    <div x-cloak x-data="db_config_data" class="mx-auto max-w-7xl sm:px-6 lg:px-8">
        <form>
            <div class="space-y-12">
                <div class="border-b border-gray-900/10 pb-12">
                    <h2 class="text-base font-semibold leading-7 text-gray-900">Configure Database</h2>
                    <p class="mt-1 text-sm leading-6 text-gray-600">Please make sure it is a public DB. Test with
                        staging DB First.</p>

                    <div class="mt-5 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                        <div class="sm:col-span-4">
                            <label for="db_url" class="block text-sm font-medium leading-6 text-gray-900">Enter DataBase
                                URL </label>
                            <div class="mt-2">
                                <input x-bind:disabled="!db_url_input_enable" x-model="formData.db_url" id="db_url"
                                       name="db_url" type="url"
                                       placeholder="postgresql://<USERNAME>:<PASSWORD>@<HOSTNAME>:<PORT>/<DB_NAME>"
                                       class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                            </div>
                        </div>
                    </div>
                    <div x-show="db_tables" class="mt-5 space-y-10">
                        <label for="db_url" class="block text-sm font-medium leading-6 text-gray-900">Select
                            Tables</label>
                        {#                        <h4 class="text-base font-semibold leading-7 text-gray-900"></h4>#}
                        {#                        <p class="text-sm text-gray-600">Only select tables which you will use for querying.</p>#}
                        <table style="margin-top: 0">
                            <template x-for="(table, index) in db_tables" :key="index">
                                <tbody>
                                <tr>
                                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-0">
                                        <input type="checkbox" x-bind:value="index"
                                               x-model="formData.selected_db_tables_idx"/>
                                    </td>
                                    <td x-text="table" @click="toggle(index)"></td>
                                </tr>
                                </tbody>
                            </template>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex items-center justify-end gap-x-6">
                <button x-show="!db_tables" @click="configureDBURL"
                        type="button"
                        class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
                        x-bind:class="{'bg-zinc-500': loading }">
                    Connect
                </button>
                <button x-show="db_tables" @click="configureLLMModelWithTables"
                        type="button"
                        class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
                        x-bind:class="{'bg-zinc-500': loading }">
                    Configure Model
                </button>
            </div>
        </form>
    </div>



{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('db_config_data', () => ({
                loading: false,
                query_result: null,
                db_url_input_enable: true,
                db_tables: null,
                formData: {
                    db_url: null,
                    selected_db_tables_idx: [],
                    selected_db_tables: []
                },
                toggle(id) {
                    if (this.formData.selected_db_tables_idx.includes(id)) {
                        const index = this.formData.selected_db_tables_idx.indexOf(id);
                        this.formData.selected_db_tables_idx.splice(index, 1)
                    } else {
                        this.formData.selected_db_tables_idx.push(id)
                    }
                },

                configureLLMModelWithTables() {
                    let selected_db_tables_idx = this.formData.selected_db_tables_idx;
                    if (selected_db_tables_idx.length === 0) {
                        alert("Please select at least one table");
                        return;
                    }
                    let ref = this;
                    selected_db_tables_idx.forEach(table_idx => {
                        ref.formData.selected_db_tables.push(ref.db_tables[table_idx]);
                    })
                    this.loading = true;
                    fetch('{% url "tool:api-v1-configure" %}', {
                        method: 'POST',
                        body: JSON.stringify(this.formData),
                        headers: {
                            'Content-type': 'application/json; charset=UTF-8',
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                    }).then((response) => {
                        response.json().then(data => {
                            ref.loading = false;
                            if (data.config_success) window.location.href = "{% url 'tool:tool-query' %}";
                            else alert("Something went wrong! Configure again");
                        });
                    }).catch((error) => {
                        ref.loading = false;
                        alert('Invalid form input! ' + error)
                    });
                },

                configureDBURL() {
                    let ref = this;
                    this.loading = true;
                    fetch('{% url "tool:api-v1-configure" %}', {
                        method: 'POST',
                        body: JSON.stringify(this.formData),
                        headers: {
                            'Content-type': 'application/json; charset=UTF-8',
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                    }).then((response) => {
                        response.json().then(data => {
                            console.log(data);
                            ref.loading = false;
                            ref.db_tables = data;
                            ref.db_url_input_enable = false;
                        });
                    }).catch((error) => {
                        ref.loading = false;
                        alert('Invalid form input! ' + error)
                    });
                }
            }))
        });
    </script>
{% endblock %}