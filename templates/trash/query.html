{% extends 'tool/base-template.html' %}

{% block main-body %}
    <div x-cloak x-data="query_data" class="min-h-full">
        {% include "tool/components/header-nav.html" %}

        <header class="bg-white shadow-sm">
            <div class="mx-auto max-w-7xl px-4 py-4 sm:px-6 lg:px-8">
                <h1 x-text="header_text" class="text-lg font-semibold leading-6 text-gray-900">Heading</h1>
            </div>
        </header>
        <main>
            <div class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
                <form class="w-full max-w-lg">
                    <div class="mb-4">
                        <label for="query" class="block text-sm font-medium leading-6 text-gray-900">Insert Natural
                            Language
                            Query</label>
                        <div class="mt-2">
                        <textarea x-model="formData.query" rows="4" name="query" id="query"
                                  placeholder="e.g. How many users signed up yesterday?"
                                  class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></textarea>
                        </div>
                    </div>
                    <div class="flex items-start justify-start">
                        <button @click="runQueryChain"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                                x-bind:class="{'bg-zinc-500': loading }"
                                type="button">
                            Run Query
                        </button>
                    </div>
                    <div x-show="query_result.result_text" class="flex items-start justify-start">
                        <div class="mt-6 w-full">
                            <div class="border-t border-gray-100 px-4 py-6 sm:col-span-2 sm:px-0">
                                <dt class="text-sm font-medium leading-6 text-gray-900">Result</dt>
                                <dd x-text="query_result.result_text"
                                    class="mt-1 text-sm leading-6 text-gray-700 sm:mt-2"></dd>
                            </div>
                        </div>
                    </div>
                    <div x-show="query_result.sql_query" class="flex items-start justify-start">
                        <div class="mt-6 w-full">
                            <div class="border-t border-gray-100 px-4 py-6 sm:col-span-2 sm:px-0">
                                <dt class="text-sm font-medium leading-6 text-gray-900">SQL Query</dt>
                                <dd x-text="query_result.sql_query"
                                    class="mt-1 text-sm leading-6 text-gray-700 sm:mt-2"></dd>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('query_data', () => ({
                header_text: "Explore Your Data",
                loading: false,
                query_result: {
                    "result_text": null,
                    "sql_query": null
                },
                formData: {
                    query: null
                },
                runQuery(url) {
                    this.loading = true;
                    let ref = this;
                    fetch(url, {
                        method: 'POST',
                        body: JSON.stringify(this.formData),
                        headers: {
                            'Content-type': 'application/json; charset=UTF-8',
                            "X-CSRFToken": "{{ csrf_token }}"
                        }
                    }).then((response) => {
                        console.log(response);
                        ref.loading = false;
                        response.json().then(data => {
                            ref.query_result = {
                                "result_text": data["result"],
                                "sql_query": data["intermediate_steps"][0]
                            };
                        });
                    }).catch((error) => {
                        ref.loading = false;
                        alert('Invalid form input! ' + error)
                    });
                },
                runQueryChain() {
                    this.runQuery("{% url "tool:api-v1-query" %}")
                }
            }))
        });
    </script>
{% endblock %}